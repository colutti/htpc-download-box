---
- name: Install all services on PI2
  hosts: 192.168.1.50
  remote_user: colutti
  gather_facts: false

  tasks:

    - name: Update the download-box github repository
      become: false
      ansible.builtin.git:
        repo: https://github.com/colutti/htpc-download-box.git
        dest: /home/colutti/Projects/htpc-download-box/
        clone: false
        update: true
        force: false
        version: master

    - name: Creating the .env file
      become: false
      ansible.builtin.copy:
        dest: /home/colutti/Projects/htpc-download-box/services/.env
        content: |
            PUID=1000
            PGID=1000
            TZ=Europe/Madrid
            ROOT=/home/colutti/media
        owner: colutti
        group: colutti
        mode: 0775

    - name: Copy homepage's services file
      become: true
      ansible.builtin.copy:
        src: /home/colutti/Projects/htpc-download-box/services/services.yaml
        dest: /home/colutti/media/config/homepage/services.yaml
        remote_src: true
        force: true
        mode: preserve

    - name: Copy homepage's docker file
      become: true
      ansible.builtin.copy:
        src: /home/colutti/Projects/htpc-download-box/services/docker.yaml
        dest: /home/colutti/media/config/homepage/docker.yaml
        remote_src: true
        force: true
        mode: preserve

    - name: Deploy Docker Compose stack
      become: false
      community.docker.docker_compose:
        recreate: always
        project_src: /home/colutti/Projects/htpc-download-box/services/
        files:
          - docker-compose.yml
